---
source: 22 - Data & Analytics\002 Athena Hands On_zh.srt
---

教师：好的, 让我们使用Athena服务,

使用SQL查询语言查询Amazon S3中的数据｡

所以我们进入了Athena, 正如我们所看到的,

这是新的编辑器｡

因此, 在运行第一个查询之前,

需要在AmazonS3中设置一个查询结果位置｡

我们单击“View settings（查看设置）”, 然后单击“Manage（管理）”｡ 

然后, 在这里, 当要指定查询结果的位置时｡ 

我需要做的就是进入Amazon S3,

创建一个bucket, 我将它命名为stephane-demo-athena-eu-central-1, 它应该是唯一的｡

然后我们会创建这个桶｡ 

现在已创建了存储桶, 我可以单击“View details”（查看详细信息）｡ 

这是我的桶, 我可以在这里复制桶的名称｡

我只需要输入s3：//, 然后输入我的存储桶名称｡ 

只需单击“保存”, 现在我的查询结果位置将位于此S3存储桶中｡

现在, 我们已经完成了这一步,

可以刷新此页面, 我们可以看到已经有一些数据源､

AwsDataCatalog和一些数据库可以使用了｡

但我要做的是创建我自己的数据库,

让它工作, 因为你可能不一定有这个｡

所以, 对于这个, 它是相当容易的｡ 

我们将在Amazon S3中创建S3访问日志｡ 

因此, 我创建了名为demo-s3-access-logs-stephane-2020的存储桶,

它在S3日志文件夹中包含我的访问日志｡

我现在要做的就是创建一个数据库,

创建一个表来显示这里的对象｡

那么, 怎么这样做呢？

好吧, 让我们进入我们的代码｡ 

在S3事件下的第一行, athena-s3-access-logs-sql,

用于创建此数据库｡

因此, 我们将粘贴此内容,

创建数据库, 然后单击“Run”｡

这样就成功创建了一个数据库, 现在我们有了一个特定的数据库,

这里称为s3_access_logs_db｡

接下来, 我们需要创建一个表示存储桶日志的外部表｡

让我粘贴, 复制, 粘贴这个｡ 

问题是, 我是怎么得到这个的？

如果你输入athena s3访问日志, 在互联网上,

你会有一个链接, 这个链接实际上会给你查询单位,

你做的, 以创建这些适当的访问日志｡

因此, 我必须更改的一件事是在location下,

何时更改目标存储桶的名称和前缀｡

我的属性会给我这个, 所以我复制这个S3

URI, 它有bucket名称和前缀.

我把这个贴在这里, 就可以开始了｡ 

现在让我们运行这个命令, 现在查询成功了｡ 

现在, 在这个数据库下, 我们看到有一个名为mybuckets_logs的表,

其中包含许多列｡

如果我单击该选项, 然后单击“Preview Table”（预览表）,

现在将从我的表中选择一颗星,

限制为10颗｡

在底部, 我们可以看到它返回了10行, 这10行代表了我的访问日志,

所以这非常方便｡

现在我可以在这个表中获得所有的访问日志数据,

非常非常方便｡

所以这只是表面现象, 因为现在,

使用Athena, 我们可以运行一些更有趣的查询类型｡

所以, 正如我们现在所看到的, 我们什么也没做｡ 

我们没有设置任何数据库, 也没有配置数据库,

这都是无服务器的｡

所有这些查询都是由Athena服务直接对S3桶中的数据运行的,

我认为这是非常强大的｡

所以, 在这个查询中, 我们要从这个表中获取requesturi_operation,

httpstatus, count star, 来计算有多少,

我们要执行GROUP BY｡

这是一个更高级的SQL查询,

但它将为我们提供一个状态代码报告日志,

以及它们发生的次数｡

因此, 我们可以看到, 例如, GET 404发生了49次,

HEAD 200发生了81次, 以此类推, 或者GET 403发生了14次｡

例如, 这可以帮助我们生成一个报告,

以便预测哪些类型的查询或哪些类型的请求在我们的bucket上没有发生或没有成功,

非常方便｡

最后一个例子, 我们看到有几个,

四个或三个错误, 所以它可以说, 嘿, 这是当它是未经授权的,

这是非常可疑的, 要么有人没有被授权做某事, 酷, 我们想知道谁和为什么｡

或者, 如果有人试图未经授权访问我们的桶,

而我们想深入了解它｡

同样, 我们运行此查询, 然后我们有44行,

这里没有这些行, 因为数据可能非常大,

但我们有44行, 好吧, 这些行将表示生成的查询类型, 并最终生成403,

这非常方便｡

因此, 再次强调, Athena的全部功能是,

我们能够在Amazon S3上查询数据,

直接执行一些复杂的查询,

而无需设置任何服务器, 无需转换数据, 只需设置正确的数据格式, 并指定数据内容,

Athena就能够帮助我们完成所有这些事情｡

最后, 在Athena中, 您可以查看最近的查询以及保存的查询（如果您愿意）,

如果您希望在目标桶中加密查询结果,

则可以编辑设置｡

这节课就讲到这里, 希望你们喜欢,

下节课再见｡
