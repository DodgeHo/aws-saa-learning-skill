---
source: 27 - Networking - VPC\016 NACL & Security Groups_zh.srt
---

- ：好的, 接下来我们将进行一个关于安全组和网络ACL（NACL）的长篇讲座｡

我们以子网为例, 当您拥有EC2实例时,

我们会将安全组附加到该实例｡

但是, 我们还没有看到子网上有一个额外的保护级别,

即网络ACL或NACL｡

让我们举一个例子来真正了解NACL在传入请求中的作用｡

因此, 一个请求将发送到您的EC2实例, 现在从网络角度看,

发生了什么情况？

首先, 请求将在进入子网之前到达NACL.

因此, NACL上将有一些要定义的入站规则｡

如果请求不被允许, 那么请求就不会进入｡

如果它被允许, 它就会进去, 对吗？

因此, NACL是无状态的｡ 

我们马上就能知道这意味着什么｡ 

因此, 第一个请求通过NACL,

然后到达子网内部, 并通过安全组入站规则｡

所以我们知道这是怎么回事｡ 

同样, 如果请求未被显式允许, 则会被拒绝｡

现在, 关于安全组的一些事情是,

它们是有状态的｡

请记住, NACL是无状态的,

而安全组是有状态的｡

那是什么意思呢？

这意味着, 如果请求通过安全组的入站规则,

并到达EC2实例, 则EC2实例将以应用程序角度需要的任何回复进行回复｡

然后, 出站将在安全组级别自动接受｡

这是因为安全组是有状态的｡ 

这意味着任何被接受的东西也可以出去｡ 

因此, 这里没有正在评估的规则｡ 

在本例中, 安全组出站规则并不重要｡

现在我们知道了安全组级别的出站总是被允许的,

因为它是有状态的, 那么还会发生什么呢？

NACL不是有状态的, 它是无状态的,

因此, 因为它是无状态的,

所以将评估NACL出站规则｡

同样, 如果他们没有通过,

那么请求将无法通过｡

这是一个传入的请求｡ 

现在, 让我们看一遍相同的场景,

但针对的是传出请求,

您可以暂停视频, 尝试自己执行此操作, 看看您是否了解有状态和无状态之间的区别｡

好吧, 我会的 你试过了吗？

好了, 我们走吧｡ 

所以这次是安全组,

EC2实例发出出站请求｡

所以它在向外界做一个请求｡ 

因此, EC2实例首先可能会使用, 例如, 连接到www｡

谷歌｡  因此,

首先要评估的规则是安全组出站规则｡

那么, 是否允许从EC2实例到Web的流量？

然后, 如果规则是正确的并且请求被允许, 则请求也会通过NACL出站规则｡

所以他们被评估｡ 

然后请求到达www. 谷歌｡  显然,

NACL是无状态的, 因此将对NACL入站规则进行评估｡

最后, 由于安全组规则的状态性,

子网内处于安全级别的入站无论如何都将被允许｡

因此, 此处安全组的入站规则不会产生任何影响,

因为管理员角色已被接受,

并且安全组是有状态的｡

希望这是有状态和无状态之间的一个非常清晰的解释｡

那么, 什么是网络访问控制列表NACL？

它们就像防火墙一样, 控制进出子网级别的流量,

每个子网都有一个NACL, 每个新子网都将被分配默认NACL｡

在下一张幻灯片中, 我们将了解默认NACL｡ 

因此, 您定义了NACL规则, 这些规则的编号从1到32,

000不等｡

优先级越高, 数字越小, 所以1是最高优先级,

最新的是32, 000, 以此类推.

第一个规则匹配将驱动决定, 好的｡ 

例如, 如果您在此CIDR上定义allow, 在同一CIDR上定义deny,

即一个特定的IP, 但allow为100,

deny为200, 则该IP地址将被允许, 因为100的优先级高于200｡

在这种情况下,

第一个规则匹配将驱动决策｡

较少的规则是星号, 在没有规则匹配的情况下将拒绝任何请求｡

现在, AWS建议以100为增量添加规则｡ 

原因是, 如果你想在两者之间添加规则,

你是可以的｡

好的, 新创建的NACL将默认拒绝所有内容｡

NACL有一个非常非常好的用例｡ 

它们非常适合在子网级别阻止特定的IP地址｡

那么, 图中的NACL在哪里呢？

我们已经知道了这张图,

但NACL还是在子网级别｡

因此, 我们可以在公共子网､

专用子网等级别使用NACL｡

因此, 默认NACL非常重要, 因为它可能会出现在考试中｡

默认的NACL有一个特殊性, 即它接受与之关联的子网的所有入站和出站信息｡

这就是IPv4的默认NACL｡

它允许所有东西进出｡ 

这就说得通了, 对吧？

因为如果NACL不允许任何东西进出,

那么当我们开始使用AWS时,

我们将不得不做一些认真的调试｡

但是默认的NACL是非常开放的｡ 

现在, 我的建议是不要修改默认的NACL｡ 

相反, 如果您希望拥有一些自定义网络ACL,

则可以创建自定义网络ACL｡

好的, 但是如果考试中提到有默认NACL,

那么请记住, 默认情况下,

此NACL将取消其与子网的关联｡

如果此NACL与子网相关联,

对不起, 则它将允许所有内容进出｡

好了, 现在让我们来了解一下“短暂港口”这个重要概念｡

因此, 当您将客户端和服务器连接在一起时, 它们必须使用端口｡

因此, 我们有IP地址和端口,

客户端通过定义的端口连接到服务器｡

例如, 我们知道HTTP端口为80,

HTTPS端口为4､ 4､ 3,

SSH端口为22, 依此类推｡

因此, 当我们有一个公开服务的服务器时, 客户端将连接到一个定义的端口,

除非客户端需要从服务器返回一个回复｡

因此, 服务器还需要连接到客户端以发送响应｡

并且客户端默认情况下没有任何开放端口｡ 

因此, 当客户端连接到服务器时,

客户端将打开其自身的特定端口｡

这个端口是短暂的,

因为它只是一个与客户端和服务器之间的连接一样长的端口｡

那么什么是短暂的港口呢？

根据您的操作系统,

您有不同的端口范围,

例如, 如果您使用的是Windows 10,

那么您会得到49, 152到65,

535, 这些端口范围将被选择用于随机的临时端口｡

如果你使用Linux,

那么一个好的范围是32,

768到60, 999｡

因此, 根据不同的操作系统,

您有不同的端口范围｡

让我们通过一个具体的例子来了解它是如何工作的｡

所以客户端连接到一个web服务器,

这个web服务器有一个固定的IP和一个固定的端口｡

所以客户端说, 嘿, 这是我的IP,

我将为这个请求或这个连接打开, 一个短暂的端口5,

0, 1, 0, 5｡

因此, 从客户端发送到服务器的请求是,

嘿, 这是目标IP, 这是您连接到的服务器的目标端口,

这是我的请求的有效负载, 这是我的源IP,

顺便说一下, 用于回复, 这是我的源临时端口, 也用于重放, 即5, 0, 1, 0,

5｡

然后, Web服务器在连接回客户端以发送回响应时,

将发送响应并说：嘿,

这是源IP, 这是源端口｡

因此, 服务器端口和目标IP是11｡

22. 33. 44,

这里是响应有效载荷｡

最后, 如果我们还需要一个端口,

它将重用客户端发送的临时端口｡

这就是它被称为临时端口的原因,

因为它是一个随机端口, 仅在连接生命周期内分配｡

那么, 我为什么要提到短暂的港口呢？

因为它们对于NACL非常重要｡

因此, 如果您考虑客户端连接到数据库,

并且我们有一个私有子网和一个公共子网, 则每个子网都有一个关联的NACL｡

因此, 一个Web NACL和一个DB NACL｡ 

现在, 当客户端启动到数据库实例的连接时,

您需要考虑哪些规则？

如果您考虑第一个NACL,

我们需要允许端口3､ 3､ 06上的出站TCP到达数据库子网CIDR,

这是有意义的｡

否则, 请求将不会离开子网｡ 

从数据库得角度来看,

DB NACL会说, 嘿,

我需要允许矶钓3, 3, 0,

6上得入站TCP从Web提交CIDR.

这一切都说得通, 对吧？

现在, 这里是棘手的部分｡ 

当数据库将请求发送回客户端时,

您认为需要发生什么？

客户端有一个临时端口, 对吧？

因此, 它们将是为该请求分配的随机端口｡

因此, DB NACL必须允许端口上的出站TCP,

以及临时端口上的出站TCP, 例如, 从1024到65, 535到Web子网CIDR,

然后Web NACL还需要允许DB子网CIDR的临时端口范围上的入站TCP｡

这就是为什么配置好临时端口非常重要的原因｡

如果您想了解更多信息,

请访问文档链接｡

关于NACL, 您需要了解的另一件事是,

如果您有多个NACL和多个子网, 则需要在NACL中允许每个NACL组合, 因为您使用的是CIDR, 而每个子网都有自己的CIDR｡

因此, 您必须认识到, 如果向NACL中添加子网,

则还需要更新所有NACL规则, 以确保连接组合是可能的｡

总而言之, 安全组和NACL之间的区别是什么？

安全组在实例级别运行, 而NACL在子网级别运行｡

安全组仅支持允许规则, 而NACL支持允许和拒绝规则,

这就是为什么您可以拒绝NACL中的特定IP地址｡

安全组是有状态的,

因此不管规则如何, 都允许自动返回流量, 而NACL是无状态的, 这意味着每次都会评估入站和出站规则,

并将临时端口视为提醒｡

现在, 对于安全组, 将评估所有规则以决定是否允许流量,

而对于NACL, 将首先评估具有最高优先级的规则, 第一个匹配的规则获胜｡

安全组适用于由某人指定的EC2实例,

而NACL适用于与之关联的子网中的所有EC2实例｡

这节课到此为止｡ 

希望这是有意义的,

我们下次课再见面练习.
