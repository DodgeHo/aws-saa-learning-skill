---
source: 17 - Decoupling applications SQS, SNS, Kinesis, Active MQ\009 SNS and SQS -  Fan Out Pattern_zh.srt
---

讲师：现在我们来谈谈SNS加SQS扇出模式｡

这个想法是, 您希望将消息发送到多个SQS队列,

但是如果将它们单独发送到每个SQS队列,

则可能会出现与之相关的问题｡

例如, 如果您的应用程序在中间崩溃,

如果存在交付失败,

或者如果您在路上添加更多SQS队列｡

因此, 我们希望使用扇出模式｡ 

这个想法是, 你要推一次SNS主题, 然后你要订阅尽可能多的SQS队列,

因为你想要的SNS主题｡

这些队列是订阅者,

他们都将接收发送到SNS的消息｡

例如, 我们有一个购买服务,

它希望向两个SQS队列发送消息｡

相反, 它会将一条消息发送到SNS主题中,

队列是该SNS主题的订阅者,

以便欺诈服务和运输服务可以从自己的SQS队列中读取所有消息｡

这样做的想法也是,

它是一个完全解耦的模型,

没有数据丢失｡

SQS将为您提供数据持久性, 延迟处理以及重试工作｡

使用这种模式, 我们可以随着时间的推移添加更多的SQS队列作为SNS主题的订阅者｡

为此, 我们需要确保您的SQS队列访问策略,

正如我们之前看到的,

允许您的SNS主题写入您的SQS队列｡

这是使用队列访问策略的另一个用例,

我们有跨区域交付｡

因此, 如果安全性允许的话,

一个区域的SNS主题完全可以向其他区域的SQS队列发送消息｡

接下来, 我们如何将这种模式用于其他目的？

例如, S3事件进入多个队列｡ 

因此, S3事件规则的一个限制是,

对于事件类型的组合, 例如, 正在创建的对象和前缀,

例如, images/,

您只能有一个S3事件规则｡

但是, 如果您想向多个SQS队列发送相同的S3事件通知,

该怎么办？

在这种情况下, 您将使用扇出模式｡ 

例如, 我们将S3对象创建为出现在您的S3存储桶中的事件,

并将此事件发送到SNS主题中, 并将许多SQS队列订阅到SNS主题作为最终模式｡

但我们也可以订阅其他类型的应用程序, 电子邮件,

Lambda函数, 等等｡

然后我们从中得到的是,

由于这种扇出模式, 在Amazon S3中发生的事件的消息将到达许多不同的目的地｡

另一种架构是, 您可以通过Kinesis

Data Firehose将数据直接从SNS发送到Amazon

S3｡

因此, 由于SNS与KDF直接集成, 因此您的购买服务可以将数据发送到SNS主题中｡

然后, Kinesis Data Firehose（KDF）将收到该信息｡

然后从Kinesis Data

Firehose, 您可以将其发送到Amazon

S3存储桶, 或者任何受支持的KDF特定目的地, 这使您能够以您想要的方式进行真正的扩展,

可能会从SNS主题中持久化您的消息｡

因此, 我们也可以将扇出模式应用于FIFO主题｡ 

因此, Amazon SNS具有FIFO或FIFO功能,

即先进先出, 它为主题中的消息提供了排序｡

所以制片人发了消息｡ 

一, 二, 三, 四｡ 

订阅者现在只能是一个SQS FIFO队列, 它按顺序接收消息,

一个, 两个, 三个, 四个｡

因此, 我们的想法是, 使用SNS

FIFO, 我们可以获得与SQS FIFO相同的功能,

我们可以通过消息组ID进行排序｡

我们使用重复数据消除ID或基于内容的重复数据消除来获得重复数据消除｡

SQS标准队列和FIFO队列都可以是订户｡ 

在吞吐量方面, 你是有限的｡ 

您将获得与SQS FIFO队列相同的吞吐量｡ 

我们为什么需要这个？

好吧, 如果你想用SQS FIFO进行扇出｡ 

因此, 您需要扇出､ 排序和重复数据删除｡ 

因此, 购买服务将把数据发送到SNS

FIFO主题中, 然后它将扇出到两个SQS

FIFO队列中, 这也可以让欺诈服务和运输服务从FIFO队列中读取｡

SNS的最后一个功能, 可以真正方便的扇出模式是,

你可以在SNS中进行消息过滤｡

什么是邮件过滤？

这是一个JSON策略,

用于过滤发送到SNS主题订阅的消息｡

因此, 如果订阅没有过滤策略,

它将接收每一条消息, 这是默认行为｡

但让我们举一个例子, 看看当我们设置一个消息过滤策略时会发生什么｡

因此, 我们有一个购买服务,

它将交易发送到SNS主题｡

例如, 交易看起来像有一个订单号,

有一个产品, 例如一支铅笔,

数量和放置的状态｡

现在, 我们只想为已下订单创建一个SQS队列, 不是所有订单,

而是仅为已下订单｡

为此, 我们将SQS队列订阅到SNS主题中,

并在JSON中应用过滤器策略, 并在策略中指定希望State等于Placed｡

因此, 只有与策略匹配的消息才会进入SQS队列,

但这样我们就可以有一个用于取消订单的SQS队列｡

因此, 我们可以为取消的订单创建自己的过滤策略,

并将来自同一SNS主题的订单放入SQS队列｡

因此, 已下达的订单和已取消的订单SQS队列将不会有相同的消息｡

我们还可以使用相同的过滤策略, 即已取消的过滤策略,

为已取消的订单创建电子邮件订阅｡

例如, 我们可以有一个用于拒绝订单的过滤器策略,

并作为另一个SQS队列, 或者我们可以创建一个没有过滤器策略的SQS队列,

以获得来自该SNS主题的所有消息｡

因此, 使用所有这些扇出模式和消息过滤, FIFO队列和FIFO主题,

我们得到了很多不同的可能性,

考试将尝试测试你对所有这些｡

这节课就到这里｡ 

希望你们喜欢,

下次课再见｡
