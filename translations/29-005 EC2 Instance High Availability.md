---
source: 29 - More Solution Architectures\005 EC2 Instance High Availability_zh.srt
---

讲师：现在我们来讨论一下解决方案架构,

看看如何使EC2实例具有高可用性｡

因为我们知道, 默认情况下,

EC2实例在一个可用性区域中启动, 它并不是真正的高可用性, 但我们可以设计一些东西来使其具有高可用性, 这就是本课程的全部目的｡

我们将看到有不同的方法来做事情,

这完全取决于您的要求和您想做的工作量｡

假设我们有一个运行Web服务器的公共EC2实例,

并且我们希望能够访问该Web服务器,

那么我们要做的是将一个弹性IP连接到该EC2实例, 这样我们的用户就可以通过此弹性IP直接访问我们的网站, 并且他们将直接与EC2实例进行通信, 这要归功于此弹性IP,

我们将从Web服务器获得一个结果, 所以这很棒｡

但现在, 我们希望拥有一个备用EC2实例,

以防万一, 这将使我们的EC2实例具有高可用性｡

现在, 我们需要能够故障切换到备用EC2实例,

以防出现问题｡

那么我们怎么知道是否出了问题呢？

好吧, 你应该认为, 任何时候你想知道什么是即将出错,

必须有某种形式的监测到位｡

因此, 我们将根据已知的事件创建一个CloudWatch事件或CloudWatch警报｡

例如, 如果我们有一个CloudWatch事件,

也许我们想看看一个实例是否被终止｡

或者, 如果我们有一个Web服务器, 并且我们知道CPU可以一直达到100%,

那么您可能希望有一个CloudWatch Alarm来监控CPU, 如果我们看到CPU达到100%, 则可能是EC2实例出现了问题,

我们希望据此触发警报｡

因此, 根据您的需求, 可以使用不同的方法来监视EC2实例｡

然后, 从警报或CloudWatch事件中,

您可以继续触发Lambda函数｡

Lambda函数允许你做任何你想做的事情,

例如, 如果实例还没有启动, 如果没有Standby EC2实例, Lambda函数可以发出API调用来启动它｡

然后, 发出API调用,

将弹性IP连接到我的备用实例｡

现在将连接弹性IP, 并且它显然将与另一个EC2实例分离,

因为弹性IP一次只能连接到一个实例,

而另一个EC2实例可能会终止或消失,

并且我们已经有效地故障切换到新的备用EC2实例｡

但是我们的用户, 因为他们与我们的架构进行通信, 由于弹性IP,

他们实际上看不到任何事情发生,

这一切都在后端｡

因此, 这是创建高可用性EC2实例的一种方法｡

但还有更多的方法｡ 

好的, 让我们来讨论第二种方法,

即使用自动缩放组｡

因此, 我们在两个可用性区域中有一个ASG, 而且我们使用的是相同的概念,

即用户将使用弹性IP与我们的应用程序进行通信,

因为这会使事情变得更简单｡

那么, 现在我们应该如何配置自动缩放组？

如果我们这样配置, 我们说实例的最小数量是一个,

最大数量是一个, 我们希望有一个所需的, 我们指定两个以上的可用性区域｡

那么, 这意味着什么呢？

这意味着我们将仅获得一个EC2实例,

并且该EC2实例可能位于第一个AZ中｡

这就是我们从这些环境中得到的｡ 

那么, 我们为什么要使用这些设置呢？

例如, 我们可以说, 在EC2实例的用户数据上,

当它出现时,

它将基于标记获取并附加此弹性IP地址｡

因此, 此用户数据将发出API调用,

弹性IP将连接到我们的公共EC2实例,

并且我们的用户将能够与我们的Web服务器进行通信｡

现在, 我们来讨论一下, 此实例将被终止,

它将关闭, 因此ASG将终止第一个实例,

并在另一个AZ中创建一个替换EC2实例,

因此, 我们得到的结果是, 第一个实例被终止, 第二个实例将运行其EC2用户数据脚本, 并连接弹性IP｡

而且我们有有效的故障转移, 因此在这种情况下,

我们不需要CloudWatch警报或CloudWatch事件,

自动扩展组一旦发现一个实例已终止（由于其设置）, 就会创建一个新的EC2实例和另一个AZ｡

我们有一个混合､ 一个最大值和一个期望值的原因是,

在整个ASG中, 我们永远不会同时运行多个实例,

这很好｡

最后, 由于EC2实例确实直接执行API调用,

因此要附加此弹性IP地址,

我们需要确保EC2实例具有实例角色, 该角色允许它发出API调用以附加此弹性IP地址｡

因此, 这里我们使用EC2用户数据来附加弹性IP地址,

并使用EC2实例角色来确保API调用成功｡

所以我们可以把这个模式扩展到另一个事物｡ 

例如, 我们的EC2实例可以是有状态的,

并具有EBS卷, 因此我们可以变得更加复杂,

因此让我们从它开始, 我们有一个自动扩展组､ 两个AZ､

我们的公共EC2实例和一个弹性IP, 我们已经知道了这一点｡

但现在, 我们还有一个EBS卷连接到EC2实例,

例如, 假设EC2实例是一个数据库, 我们正在尝试使该数据库具有高可用性｡

因此, 我们的所有数据都存储在EBS卷上,

并且我们知道EBS卷锁定在特定的可用性区域中｡

因此, 让我们想象一下, 我们的EC2实例正在被终止, 现在我们应该做什么？

我们知道, 在终止时,

自动扩展组可以使用生命周期挂钩,

由于有了这个生命周期挂钩,

我们可以创建一个脚本来获取EBS卷, 并从中创建EBS快照｡

因为, EC2实例一停止运行,

就会触发该事件, 因此我们知道EBS卷将受到磨损｡

因此, 我们有一个EBS快照,

并对其进行了正确标记,

ASG将启动一个替换EC2实例,

我们的设置与之前相同,

现在, 通过再次正确配置自动扩展组以在启动事件上创建生命周期挂钩, 我们可以在正确的可用区中从此EBS快照创建一个EBS卷, 然后将其连接到替换EC2实例｡

然后, EC2用户现在可以检查该属性,

并直接附加弹性IP地址, 我们需要确保API调用显然是正确的, 因此我们需要有一个EC2实例角色, 正如我们在这里看到的,

我们已经完成了EC2用户数据､

以及生命周期挂钩, 以确保EBS卷首先获得快照, 然后从快照恢复到不同的AZ｡

这使它成为一个具有EBS卷的高可用性EC2实例｡

因此, 我们可以看到, 可能性是无限的,

但很高兴看到他们一次, 看看这些类型的架构是如何工作的,

显然, 他们是一个有点多的工作, 他们是一个有点多的定制, 但我们可以实现伟大的事情与自动化｡

这节课就讲到这里, 希望你们喜欢,

下节课再见｡
