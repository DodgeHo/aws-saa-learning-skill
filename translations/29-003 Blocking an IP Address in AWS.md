---
source: 29 - More Solution Architectures\003 Blocking an IP Address in AWS_zh.srt
---

讲师：好的, 这将是一个关于网络讨论和安全的讲座,

但非常重要, 因为我希望你真正理解当请求来自客户端并一直到达应用程序时会发生什么｡

因此, 有时我们可能想要阻止客户端的IP地址,

因为它将是一个坏角色｡

也许它在试图进入我们的应用程序

所以, 我们想知道防御线｡ 

因此, 让我们从这个非常简单的解决方案架构开始,

其中我们在VPC中的安全组中拥有EC2实例｡

并且该实例具有公共IP,

因此可以公开访问｡

这就是我们的客户端如何进入我们的EC2实例｡ 

假设我们想阻止那个客户｡ 

第一道防线将是我们的VPC中的网络ACL,

这是VPC级别的｡

在此网络ACL中, 我们可以为此客户端IP地址创建拒绝规则｡

非常简单, 非常快, 非常便宜,

客户端只会被弹出｡

那么对于EC2实例的安全组, 我们不能有deny规则,

只能有allow规则｡

因此, 如果我们知道只有授权客户端的一部分可以访问我们的EC2实例,

那么在我们的安全组中,

只定义允许进入我们的EC2实例的IP子集是很好的｡

但如果我们的应用程序是全局的,

我们显然不知道所有将访问我们的应用程序的IP地址, 因此这里的安全组不会有很大的帮助｡

最后, 您可以在EC2上运行一个可选的防火墙软件,

以阻止来自客户端的请求｡

现在很明显, 如果请求已经到达您的EC2实例,

那么它将必须被处理, 并且处理该请求将有CPU成本｡

这是一个非常简单的用例,

但我们已经看到了NACL､ 安全组和主机防火墙之间的区别｡

现在让我们再进一步｡ 

我们介绍了一个应用程序负载均衡器｡ 

同样, 这个ALB是在我们的VPC中定义的, 我们仍然有我们的EC2实例,

但现在我们有两个安全组｡

我们有ALB安全组和EC2安全组｡

因此, 在这种情况下,

我们的负载均衡器将在我们的客户端和EC2之间,

它将执行称为连接终止的操作｡

因此, 客户端实际上连接到ALB,

ALB将终止连接并启动从ALB到EC2实例的新连接｡

在这种情况下, 我们的EC2安全组必须配置为允许ALB的安全组,

因为EC2实例可以部署在具有私有IP的私有子网中, 并且它看到的流量来源来自ALB,

而不是客户端｡

因此, 从安全组的角度来看,

我们只允许ALB安全组, 我们在这一边是安全的｡

现在, 对于ALB的安全组, 我们需要允许客户端｡

同样, 如果我们知道IP的范围,

那么我们可以将密钥配置为组｡

如果它是一个全局应用程序, 我们必须允许一切｡ 

然后, 我们的防线将在网络ACL级别｡

好吧, 这是有道理的,

这应该是你已经知道的东西｡

因此, 对于网络负载均衡器,

现在非常类似, 您将安全组附加到网络负载均衡器,

并将安全组附加到EC2实例｡

确保规则允许从网络平衡器到EC2安全组和从NLB安全组从客户端的流量,

并且您可以控制沿途的流量｡

现在让我们回到我们的应用程序平衡器,

看看如何进一步过滤流量｡

我们可以做的拒绝IP是安装WAF或Web应用程序防火墙｡

现在这个WAF会稍微贵一点, 因为这是一个额外的服务和防火墙服务｡

但是在这里, 我们能够对IP地址进行一些复杂的过滤,

我们可以建立规则来计算请求, 以防止来自客户端的大量请求同时发出, 因此我们对ALB的安全性有更多的控制权｡

因此, WAF不是您的客户端和ALB之间的服务,

它是我们在ALB上安装的服务,

我们可以定义一系列规则, 因此这是另一条防线｡

类似地, 如果我们在ALB前面使用CloudFront, CloudFront

front位于我们的VPC之外, 好吗？

因此, 我们的ALB需要允许来自边缘位置的所有CloudFront公共IP,

并且在线上有一个列表, 但仅此而已｡

因此, 从ALB来, 它看不到客户端IP｡ 

它看到的是CloudFront公共IP｡ 

因此, 这里的网络是ACL,

它位于我们的VPC边界, 根本没有帮助, 因为它不能帮助我们阻止客户端的IP地址｡

因此, 在这种情况下,

如果我们试图阻止客户端访问CloudFront,

我们有两种可能性｡

假设我们受到某个国家/地区的攻击,

那么我们可以使用CloudFront地理限制功能来限制客户端在CloudFront上被拒绝的所有国家/地区｡

或者, 如果有一个特定的IP困扰我们, 我们可以再次使用WAF或Web应用程序防火墙来做一些IP地址过滤,

就像我们以前做的那样｡

但是, 正如我们所看到的, 基于我们的架构,

我们有不同的防线来阻止IP地址,

它们是正常的｡

一旦我们把所有的东西放在一起, 一切都有意义｡ 

但我认为, 通过一个图表向您展示从网络角度发生的事情､

如何正确配置安全组以及在何处设置IP地址过滤是非常好的｡

好的, 我希望你们能理解这节课｡ 

我希望这是有意义的,

下次课再见｡
