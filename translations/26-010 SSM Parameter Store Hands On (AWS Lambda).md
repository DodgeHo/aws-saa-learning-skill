---
source: 26 - AWS Security & Encryption KMS, SSM Parameter Store, Shield, WAF\010 SSM Parameter Store Hands On (AWS Lambda)_zh.srt
---

Stephane：我们看到了如何使用CLI来检索这些内容,

但是我们使用Lambda来增加它的趣味性并使用SDK如何？

我认为这是一个值得了解的有效用例,

所以让我们来了解一下, 因为它很有趣｡

我们要创建一个函数,

这个函数叫做hello world SSM, 运行时我会选择Python

3｡ 6, 例如,

3｡ 7, 但是你可以选择任何Python

3-dot-whatever, 对于权限, 我们需要为Lambda函数提供IAM角色｡

我将创建一个执行角色, 并在此处创建一个具有基本Lambda权限的新角色,

然后单击“创建函数”, 这样将创建一个名为hello

world SSM role的角色,

然后是此处的blovus文本, 这将为函数提供写入CloudWatch日志的权限｡

之后我们要做的是接受这个角色,

并向其添加额外的权限, 以允许其读写SSM参数存储,

然后向下滚动, 找到要修改的Lambda函数代码｡

因为这是AWS, 所以我们将导入Boto,

这将允许我们使用Boto调用SDK｡

现在我会说SSM等于boto｡  客户端, 客户端的名称为SSM,

区域名称等于,

这取决于您放置您想要的任何内容｡

对我来说, 这是欧盟西部3, 因为我在巴黎地区｡ 

好了, 我们有了SSM客户端,

正如你所看到的, 它显然是在Lambda函数之外定义的,

我们要做的第一件事是, 获取DB

URL, 我会说DB URL等于blah, 然后我们要获取DB密码, 我会说DB密码等于this, 我们要将DB

URL输出到控制台, 同时我们还要输出DB密码,

好吗？

“工作完了我们就回去｡  “好的, 那么这很简单｡

现在, 我们需要继续使用SSM API｡ 

所以这也很简单｡ 

对于DB URL, 我们将执行ssm｡  get parameters,

这里有一个names变量,

我只输入一个名字,

所以我就用这个, dev的名字？

对于数据库密码, 我将使用相同的API,

获取参数, 但这一个我会说数据库密码｡

这看起来已经足够好了,

让我们来试试看它是如何工作的｡

很明显, 这是行不通的, 但我们马上就会知道为什么｡ 

这就是我们的功能｡ 

我将单击test, 创建一个新的事件名称,

然后输入helloworld, 最后输入create｡

好了, 我们的函数保存了｡ 

现在我要测试它, 结果是失败｡ 

第一个, 它表示无法导入模块“Lambda函数”｡

“所以没有模块命名为“boto”,

这是因为我搞砸了, 它是boto3, 我需要导入,

而不是boto｡

点击保存, 再次点击测试,

现在我们得到另一个错误｡

这里显示发生了错误｡ 

调用获取参数操作时出现拒绝访问异常错误｡

我的Lambda基本执行SSM没有被授权执行SSM获取参数,

所以这是有意义的, 我们还没有更改IAM角色, 所以让我们现在就做｡

现在我们进入角色,

然后在这里找到hello world SSM角色,

在这里添加内联策略, 然后选择服务｡

对于服务, 我将键入systems manager｡ 

然后我们将选择一个操作,

在read中, 我将允许获取参数, 也可以通过路径获取参数, 然后对于资源,

我们将选择特定的资源, 我将单击“添加ARN”｡

就区域而言, 我只允许任何区域｡ 

我只允许任何帐户｡ 

但是对于完全限定的参数名, 如果我们返回到系统管理器,

也许我只想允许我的应用程序｡

我只说我的应用程序, 因为树的关系,

我们现在只允许我的应用程序下的任何内容,

然后带星号｡

所以在我的应用程序下任何带星的东西都应该被允许｡ 

我们将单击“添加", 这里有一个非常严格的IAM策略,

这确实是最佳做法｡

现在我们来回顾一下策略,

好的, 我们对SSM的访问是有限的,

这条路径应该在这里的这个参数下, 所以这是有意义的｡

好的, 我们很好, 制定政策｡ 

对了, 名字呢, 我们就叫它SSM access for my app｡ 

好的, 创建策略, 现在我们有了应用内联策略的SSM访问权限,

让我们返回Lambda管理控制台｡

我们将刷新此页面, 现在我们可以从设计器中看到,

我们可以访问Amazon Simple

Systems Manager, 因为我们更改了IAM角色｡

因此, 如果我们单击“测试”, 我们会得到一个新的失败,

所以我们仍然会得到一个授权异常,

所以有时你会遇到问题, IAM会被缓存, 或者IAM不会立即反映到你的函数上,

所以我们只需要等待一段时间｡

等了大概五分钟后, 我会再次尝试并单击“测试”,

现在它显示“工作”, 因为IAM允许我们做我们想做的事情｡

如果我们向下滚动, 我们可以看到参数｡ 

有一个dev URL是dev｡

数据库中｡  斯蒂芬老师｡  com,

然后就dev密码而言, 就在这里, 我们可以看到这是一个安全的字符串,

值是加密的｡

现在我们要解密它, 向下滚动,

这里有一个标志, 它被称为with decryption

equals true, 现在我们说, 好的, 我们的DB密码, 我希望解密发生｡

我将单击“保存",

现在我将再次测试我的函数,

但这次我将遇到一个错误,

很明显, 我们将再次遇到一个访问被拒绝的错误,

因为我们不允许使用客户主密钥解密我们的机密｡

事实证明, 由于已将IAM角色的访问权限授予KMS,

因此我们不允许解密机密, 这很好地证明了即使我可以访问此数据库密码,

但由于它已加密, 而我无法访问KMS, 因此我无法解密它, 因此DB密码确实安全可靠｡

大家都知道该怎么做了, 为了解决这个问题, 我将转到IAM并添加一个内联策略｡

对于服务, 我将选择KMS, 对于右侧的操作,

我将允许解密, 因为我们需要解密我们的机密,

所以这是我需要添加的唯一内容,

就我可以访问的资源而言, 我将说, 您可以访问特定的密钥,

区域将是任意的, 帐户将是任意的, 密钥ID是, 我们需要找到此密钥的密钥ID, 所以让我们回到EC2｡

我们很快就去IAM｡ 

IAM, 我们要加密密钥｡ 

加密密钥我将转到我所在的区域,

这是中间的教程密钥, 所以我将保留这里的ID, 这就是我将要添加的内容｡

所以现在我们有了这个密钥, 我们可以解密了｡ 

我们将回顾策略,

我们将说KMS解密教程密钥, 创建策略, 现在我们已经为Lambda函数提供了一些KMS功能｡

因此, 如果我返回Lambda控制台,

现在刷新UI, 我应该会在设计器中看到KMS｡

太好了, 现在我们可以访问参数存储和KMS｡ 

如果我这次测试我的函数, 我得到了一个成功, 它工作了,

所以如果我现在看我的dev

URL仍然是相同的, 但如果我看我的数据库密码, 它已经被解密为值｡

这是开发人员密码,

因此可以立即应用IAM策略, 我们可以做到这一点,

因此非常酷｡

现在我们已经基本上展示了如何使用解密来获取参数,

现在我想向大家展示一个在dev和prod之间切换的小技巧,

让我们转到环境变量, 我会说dev或prod, 这次我会说dev, 所以我们将使用此环境变量｡

所以我们会说dev或prod等于一个操作系统｡  我们必须这样做｡

我还将导入操作系统, 现在我们将能够在代码中引用dev或prod,

因此为了快速起见, 我将在中间使用它｡

现在, 我们基本上是说, 如果我们在开发或生产中,

我们将更改我们尝试访问的参数的名称｡

我会保存它, 现在如果我测试我的函数,

现在它工作了, 我得到了我的dev参数, 所以我们在dev中,

但是如果我向下滚动, 转到我的环境变量, 现在我想访问prod, 我会保存它, 然后我测试我的函数｡

同样, 它起作用了, 但这次如果你向下滚动, 我们会看到我们得到了我的应用程序/prod/db

URL, 也就是prod｡

数据库中｡  stephane,

还可以访问prodDB密码, 也就是prodpassword, 这真的非常棒,

因为现在只需使用一个简单的环境变量, 我们就可以让Lambda函数指向SSM中的正确参数｡

这就是我想向您展示的全部内容,

但我认为这是一个很酷的教程, 向您展示了CLI,

然后是Lambda｡

我希望你们喜欢它, 我们下节课再见｡
