---
source: 17 - Decoupling applications SQS, SNS, Kinesis, Active MQ\002 Amazon SQS - Standard Queues Overview_zh.srt
---

教师：现在我们来谈谈SQS,

SQS的核心是队列, 因为SQS是一个简单的队列服务｡

因此, 我们有一个SQS队列,

它将包含消息｡

为了包含消息,

需要将消息发送到SQS队列中, 而将消息发送到SQS队列中的任何东西都称为生成器｡

所以我们有可能有一个生产商, 但也有可能有更多｡

您可以让多个生成器将许多消息发送到SQS队列中｡

他想要什么信息都行｡ 

例如, 它可以处理此订单,

或处理此视频｡

您创建的任何消息都将进入队列｡ 

然后需要处理来自队列的消息并接收它们,

这就是所谓的消费者｡

消费者将轮询队列中的消息, 这意味着他们将询问队列,

您有给我的消息吗？

然后排队的人说, 是的, 在这里｡ 

消费者将轮询这些消息并获得一些信息｡

然后, 它将对该消息进行处理,

然后将其从队列中删除｡

您可能有多个使用者使用SQS队列中的消息｡

因此, 这里的队列服务是一个缓冲区,

用于在生产者和消费者之间解耦｡

现在, SQS是一项复杂的服务,

我们将深入了解,

但第一个产品称为Amazon SQS, 用于标准队列｡

SQS是AWS历史上最古老的产品｡ 

它是AWS上的首批服务之一｡ 

它已经有10年的历史了, 所以它的工作原理已经非常非常固定了｡

它是一个完全托管的服务,

将用于分离应用程序｡

因此, 每当您在考试中看到应用程序解耦时,

请考虑Amazon SQS｡

为什么SQS如此特别？

我们的吞吐量是无限的｡ 

这意味着每秒可以发送任意多的消息,

并且队列中也可以包含任意多的消息｡

因此, 吞吐量没有限制,

队列中的消息数量也没有限制｡

现在, 每条消息都是短暂的｡ 

那是什么意思？

这意味着, 默认情况下,

邮件将在队列中停留四天, 邮件在队列中的最长时间为14天｡

这意味着, 一旦将消息发送到队列,

使用者就必须读取该消息, 并在该保留期内处理完该消息后将其从队列中删除, 否则,

该消息将丢失｡

然后我们就有了低延迟｡ 

因此, SQS对他们来说意味着, 无论何时发送消息或从SQS读取消息,

您都将得到非常快的响应,

发布和接收时间不到10毫秒｡

SQS中的消息必须很小｡ 

每个发送的邮件必须小于256 KB｡ 

现在SQS是一个队列服务,

因此您可以看到高吞吐量､ 高容量等,

因此可能会有重复的消息｡

这意味着, 例如,

有时一个消息将被传递两次, 这就是为什么它被称为至少一次传递｡

如果您继续编写应用程序, 您需要考虑到这一点｡

它还可能有未按顺序订购的消息, 这意味着它是尽力订购,

我们将看到SQS提供的另一种类型的产品可以处理这一限制, 但我们将在本节稍后部分看到这一点｡

那么, 让我们回到消息生成器｡ 

因此, 生成器会将最大为256

KB的消息发送到SQS｡

它是如何发生的？

生产商将使用SDK（软件开发工具包）将消息发送到SQS｡

将消息发送到SQS的API称为SendMessage｡ 

很简单的｡ 

现在, 将写入消息,

并将其保存到SQS队列中,

直到使用者读取并删除该消息, 这表示该消息已被处理｡

我们知道保留｡ 

那么, 生成消息的用例是什么呢？

例如, 您希望处理订单（如包裹）,

然后将其运送到中心｡

因此, 您希望在自己的时间内完成此操作,

以便向SQS队列中发送一条消息, 其中可能包含一些信息, 如订单ID､

客户ID和您可能需要的任何属性｡

例如, 地址等等｡ 

然后, 您的消费者, 即应用程序权限中的消费者,

将不得不处理该消息本身｡

因此, 再次确认,

SQS标准具有无限吞吐量｡

我们已经看到了制片人｡  很简单的｡ 

现在我们来看看消费者｡ 

消费者是我们必须使用一些代码编写的应用程序,

这些应用程序可以在EC2实例上运行,

例如AWS上的虚拟服务器, 但如果您愿意, 它们也可以在您自己的内部部署服务器上运行, 或者, 我们还没有看到, 但它们也可以在AWS Lambda上的Lambda函数上运行｡

我们将在本课程中了解到,

这是一种无服务器计算类型的服务｡

这意味着你也可以直接从他们那里读取消息｡

我们稍后会在本课程中看到这一点, 请不要担心｡ 

因此, 回到我们关于EC2实例的简单用例,

我们的队列有一个使用者,

使用者轮询SQS以获取消息｡

这意味着消费者会问队列,

你有给我的消息吗？

并且消费者一次可以接收多达10条消息｡ 

因此, 如果SQS队列中有消息,

它将收到一个有效的响应,

说明这些消息正在等待您｡

然后, 消费者, 也就是您的代码,

有责任处理这些消息｡

例如, 将一些订单插入RDS数据库｡ 

因此, 您将继续为每个订单将其插入到您的RDS数据库中,

您必须编写一些内容, 显然是使用您的代码, 然后, 由于这些消息已被处理,

因为它们已被接收并插入到Amazon RDS数据库中,

您的消费者将继续使用DeleteMessage API从队列中删除这些消息｡

这将保证没有其他使用者能够看到这些消息,

因此消息处理完成｡

现在我们可以扩大规模｡ 

我们可以同时拥有多个消费者｡ 

因此, 我们的SQS队列可以有多个使用者,

这些使用者将并行接收和处理这些消息｡

这里我们有三个EC2实例,

每个使用者将通过调用poll函数接收不同的消息集｡

因此, 如果某个使用者处理消息的速度不够快,

它就会被其他使用者接收到,

这就是为什么我们至少有一次传递｡

这也是为什么我们采用尽力而为消息排序的原因｡ 

现在, 正如我所说的, 当消费者使用完这些消息时,

他们必须删除它们, 否则, 其他消费者将看到这些消息｡

这意味着, 如果我们需要通过SQS队列提高吞吐量,

因为我们有更多的消息, 那么我们可以添加使用者并进行横向扩展, 以提高处理的吞吐量｡

因此, 如果您还记得我们说过的话,

这是一个将SQS与自动缩放组（ASG）配合使用的完美用例｡

那么, 这是什么意思？

这意味着您的使用者将运行在Auto

Scaling组中的EC2实例上, 并且它们将轮询SQS队列中的消息｡

但是, 现在您的自动缩放组必须根据某种指标进行缩放,

而我们可以使用的一个指标是队列长度｡

它被称为近似消息数｡ 

这是一个CloudWatch指标, 可用于任何SQS队列｡ 

我们可以设置一个警报,

例如, 每当队列长度超过一定水平时, 请设置一个CloudWatch警报,

此警报应将我的自动缩放组的容量增加X个数量｡

这将保证您的SQS队列中的消息越多（可能是因为您的网站上订单激增）,

您的自动缩放组将提供越多的EC2实例, 您将相应地以更高的吞吐量处理这些消息｡

这是一个非常常见的集成,

您将在考试中看到｡

现在, SQS的使用情形是在应用程序之间进行解耦,

也就是应用程序层｡

例如, 让我们以处理视频的应用程序为例｡

我们可以只有一个大型应用程序, 称为前端,

它将接受请求, 每当需要处理视频时,

它将进行处理, 然后将其插入S3存储桶｡

但问题是, 处理可能会非常,

非常长的时间来做, 它可能只是放慢您的网站, 如果你这样做的前端在这里｡

因此, 您可以在这里分离应用程序,

并说, 等一下, 处理文件的请求和文件的实际处理可以在两个不同的应用程序中发生｡

因此, 无论何时收到处理文件的请求,

都将向SQS队列发送一条消息｡

现在, 当您发出要处理的请求时,

该文件将位于SQS队列中,

您可以创建第二个处理层, 称为后端处理应用程序,

该应用程序将位于其自己的自动缩放组中, 以接收这些消息､

处理这些视频并将它们插入S3存储桶｡

因此, 正如我们在此架构中所看到的,

我们可以相应地扩展前端, 也可以相应地扩展后端,

但这两种扩展是独立的｡

因为SQS队列具有无限的吞吐量,

并且就队列而言, 它具有无限数量的消息,

所以你真的很安全, 这是一种健壮且可伸缩的体系结构｡

此外, 对于您的前端,

您可以使用最佳类型的EC2实例或架构｡

对于后端, 如果您正在进行一些视频处理,

则可以使用一些具有GPU（图形处理单元）的EC2实例, 因为您知道这些类型的实例最适合处理此类工作负载｡

这就是考试中要用到的体系结构,

也是大家应该了解的, 这是SQS队列的一个非常棒的使用案例｡

最后是SQS安全性｡ 

因此, 我们通过使用HTTPS

API发送和生成消息来实现动态加密, 使用KMS密钥实现静态加密,

如果需要, 我们还可以进行客户端加密, 但这意味着客户端必须自己执行加密和解密｡

它不是由SQS提供的现成支持｡ 

对于访问控制, IAM策略将能够控制对SQS

API的访问, 但我们也有SQS访问策略,

类似于S3存储桶策略, 当您希望跨帐户访问SQS队列, 或希望允许其他服务（例如我们很快将看到的SNS或Amazon S3）写入SQS队列时,

这些策略非常有用｡ S3事件｡

以上就是SQS的概述｡ 

我希望你们喜欢它,

我们下次课再见, 进行一些练习｡
